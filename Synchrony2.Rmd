---
title: "Synchrony from multivariate models"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "Teresa Bohner"
date: "4/28/2020"
output: 
  html_document:
    toc: true
    collapsed: false
    toc_float: true
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
knitr::opts_chunk$set(fig.path = "figures/")
```

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(brms)
library(tidybayes)
library(viridis)
library(scales)
library(cowplot)
library(ggridges)
library(ggstance)
library(modelr)

```

## Overview

### Questions
1.  How does synchrony of tree growth vary across regional/elevation gradients?
Prediction: higher synchrony in lower latitude and lower elevation (drier) populations (SIASH, dendrochronological principles)

2.  Within populations is intraspecific synchrony greater than interspecific synchrony? Between specific species pairs? With increasing distance?
Prediction: higher synchrony among intraspecific pairs, potentially higher synchrony between pine pairs versus pine-fir pairs (successional stages), and lower synchrony with increasing distance

3.  How has synchrony changed through time? Are changes more dramatic in certain populations? Is increased or decreased synchrony associated with certain environmental variables?
Prediction: synchrony has increased with time, increased synchrony associated with drier, more variable time windows, changes are more pronounced in xeric populations.

Synchrony is explored here through residual correlations betweeen trees from multivariate models of tree growth.
```{r data}
rings_field <- read.csv("Processed Data/matched_rings_field.csv")  %>% 
  group_by(Site, Neighborhood, Species) %>% 
  mutate(comp_BA=BA_con+BA_het) %>%
  arrange(Site, Neighborhood, Species, ID)
  
region <- rings_field %>% 
  ungroup() %>% 
  dplyr::select(c(Site, Region, hilo)) %>% 
  group_by(Site) %>% 
  summarize_all(first) %>% 
  mutate(Region=factor(Region, levels=c("San Jac", "SENF", "SEKI", "Mammoth")))

ids <- ungroup(rings_field) %>% 
  dplyr::select(c(Site, Neighborhood, tree.uniqueID)) %>% 
  group_by(Site, Neighborhood, tree.uniqueID) %>%  summarize_all(first)

tree_data <- rings_field %>% 
  group_by(tree.uniqueID) %>% 
  summarise(DBH=first(DBH),
            comp_BA=first(comp_BA))

precip <- read.csv("Processed Data/precip_temp_spei.csv")

decade <- seq(1910, 2020, by=10)

precip_summary <- expand_grid(precip, decade) %>% 
  filter(Year-decade>-29, Year<=decade) %>% 
  group_by(Site, siteno, Neighborhood, hilo, decade) %>% 
  summarise_at(vars(total_ppt_mm, mean_temp_C, spei12), list(mean=function(x) mean(x, na.rm=T), sd=function(x) sd(x, na.rm=T))) %>% 
  left_join(region) %>% 
  ungroup()

spp_pairs <- expand_grid(Species.x=c("ac", "pj", "pl", "pp"), Species.y=c("ac", "pj", "pl", "pp")) %>% 
  mutate(pair_first=str_c(Species.x, Species.y, sep="-"),
         pair=c("ac-ac", "ac-pj", "ac-pl", "ac-pj", "ac-pj", "pj-pj", "pj-pl", "pj-pp", 
                      "ac-pl", "pj-pl", "pl-pl", "pl-pp", "ac-pp", "pj-pp", "pl-pp", "pp-pp")) %>% 
  dplyr::select(-c(pair_first))

pearson <- read.csv("Processed Data/synchrony_dat.csv") %>% 
  na.omit() %>% 
  filter(Site.x !="ic") %>% 
  mutate_at(vars(Species.x, Species.y), tolower) %>% 
  left_join(spp_pairs) %>% 
  mutate(spp1=str_sub(pair, 1,2),
         spp2=str_sub(pair, 4,5),
         comp=ifelse(Species.x==Species.y, "intra", "inter"))


pearson_t <- read.csv("Processed Data/synchrony_decadal_pearson.csv") %>% 
  na.omit() %>% 
  filter(Site.x !="ic") %>% 
  mutate_at(vars(Species.x, Species.y), tolower) %>% 
  left_join(spp_pairs) %>% 
  mutate(spp1=str_sub(pair, 1,2),
         spp2=str_sub(pair, 4,5),
         comp=ifelse(Species.x==Species.y, "intra", "inter"))

## join all data ----
alldata <- pearson %>% 
  left_join(tree_data, by=c("tree2"="tree.uniqueID")) %>% 
  mutate(sizeratio=ifelse(DBH.x>DBH.y, DBH.x/DBH.y, DBH.y/DBH.x),
         Region=factor(Region, levels=c("San Jac", "SENF", "SEKI", "Mammoth"))) %>% 
  mutate_at(vars(dist, sizeratio, comp_BA), scale)

alldata_t <- pearson_t %>% 
  left_join(tree_data, by=c("tree2"="tree.uniqueID")) %>% 
  mutate(sizeratio=ifelse(DBH.x>DBH.y, DBH.x/DBH.y, DBH.y/DBH.x),
         Region=factor(Region, levels=c("San Jac", "SENF", "SEKI", "Mammoth"))) %>% 
  mutate_at(vars(dist, sizeratio, comp_BA), scale) %>% 
  left_join(dplyr::select(precip_summary, -c(Region, hilo)), by=c('Site.x'='Site', 'decade'='decade'))

  
```

## Q2 Intra-interspecific competition

We modeled the annual growth increment of all of the trees in a given neighborhood jointly to estimate their residual correlations (similar to calculating pearsons pairwise correlations).

### Pairwise residual correlation summaires: 
``` {r funs_and_manip}
## function to extract data at the species level----
spp_subsetter <- function(data, sp) {
  a <- filter(data, pair==paste(sort(c(sp, "ac")), collapse="-")) %>%
    mutate(focal_sp=sp,
           comp_sp="ac")
  b <- filter(data, pair==paste(sort(c(sp, "pj")), collapse="-")) %>%
    mutate(focal_sp=sp,
           comp_sp="pj")
  c <- filter(data, pair==paste(sort(c(sp, "pl")), collapse="-")) %>%
    mutate(focal_sp=sp,
           comp_sp="pl")
  d <- filter(data, pair==paste(sort(c(sp, "pp")), collapse="-")) %>%
    mutate(focal_sp=sp,
           comp_sp="pp")
  
  bind_rows(a,b,c,d) %>%
    mutate(comp_sp=ifelse(comp_sp==focal_sp, "self", comp_sp))
}

## summary data for median correlation
summary <- group_by(alldata, spp1, spp2, pair) %>% 
  summarise(med=median(pearson_r))

## subset species----
acdat <- spp_subsetter(alldata, "ac")
pjdat <- spp_subsetter(alldata, "pj")
pldat <- spp_subsetter(alldata, "pl")
ppdat <- spp_subsetter(alldata, "pp")


```

*note difference in distribution with when keeping all of the draws versus summarizing median correlations. 


```{r fig}
## matrix style figure
ggplot(alldata, aes(pearson_r, fill=comp)) +
  geom_density(aes(y = ..scaled..), alpha=0.5) +
  facet_grid(spp2~spp1) +
  theme_test() +
  geom_vline(data=summary, aes(xintercept=med), linetype="dashed") +
  ylab("proportion") + xlab("pearson correlation")

# show_col(viridis_pal()(5)) # get the hex codes for the colors
#440154FF
cols <- c("self"="#440154FF", "pj"="#3B528BFF", "pl"="#21908CFF", "pp"="#5DC863FF", "ac"="#FDE725FF") ## keep species cols consistent

p1 <- ggplot(acdat, aes(pearson_r, color=comp_sp, fill=comp_sp)) +
  geom_density(position = "identity", alpha=0.5) +
  theme_test() +
  ggtitle("A. concolor") +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  theme(legend.position = 'none') +
  xlab("pearson correlation")

p2 <- ggplot(pjdat, aes(pearson_r, color=comp_sp, fill=comp_sp)) +
  geom_density(position = "identity", alpha=0.5) +
  theme_test() +
  ggtitle("P. jeffreyi") +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  theme(legend.position = 'none') +
  xlab("pearson correlation")

p3 <- ggplot(pldat, aes(pearson_r, color=comp_sp, fill=comp_sp)) +
  geom_density(position = "identity", alpha=0.5) +
  theme_test() +
  ggtitle("P. lambertiana") +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  theme(legend.position = 'none') +
  xlab("pearson correlation")

p4 <- ggplot(ppdat, aes(pearson_r, color=comp_sp, fill=comp_sp)) +
  geom_density(position = "identity", alpha=0.5) +
  theme_test() +
  ggtitle("P. ponderosa") +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  theme(legend.position = 'none') +
  xlab("pearson correlation")

dummy <- ggplot(bind_rows(acdat, pjdat), aes(pearson_r, color=comp_sp, fill=comp_sp)) +
  geom_density(alpha=0.5) +
  theme_test() +
  ggtitle("P. lambertiana") +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  labs(fill = "Competitor", color="Competitor")

legend <- cowplot::get_legend(dummy)
# plot_grid(legend)

plot_grid(plot_grid(p1,p2,p3,p4, ncol=2), legend, ncol=2, rel_widths = c(1,.2))
```

### Correlation response model: 
We wanted to test the relationship between the pairwise correlations and distance, size ratios, species-pairs, and locations of all of the trees. We built hierarchical mixed models with the pairwise correlations as a responses (normal). 

```{r sync_mixed_model}
mod12 <- readRDS("saved models/pearson models/mod12.rds")

mod12 %>% 
  gather_draws(b_dist, b_sizeratio) %>% 
  median_qi(.width = c(.50, .95)) %>% 
  ggplot(aes(y=.variable, x=.value)) +
  geom_pointintervalh() +
  geom_vline(xintercept=0, linetype="dashed") +
  theme_test() + ylab("") + xlab("parameter estimate")

mod12 %>% 
  spread_draws(b_Intercept, r_pair[pair,]) %>% 
  mutate(spp_mean=b_Intercept + r_pair) %>% 
  median_qi(.width = c(.50, .95)) %>% 
  ggplot(aes(y=pair, x=spp_mean, xmin=spp_mean.lower, xmax=spp_mean.upper)) +
  geom_pointintervalh() +
  geom_vline(xintercept=0, linetype="dashed") +
  theme_test() + ylab("") + xlab("Synchrony effect estimate")


mod12 %>% 
  spread_draws(r_pair[pair,]) %>% 
  compare_levels(r_pair, by = pair) %>%
  median_qi(.width = c(.50, .95)) %>% 
  mutate(pair1=str_sub(pair, 1,5),
         pair1_spp1=str_sub(pair, 1,2),
         pair1_spp2=str_sub(pair, 4,5),
         pair1_comp=ifelse(pair1_spp1==pair1_spp2, "intra", "inter"),
         pair2=str_sub(pair, 9,13),
         pair2_spp1=str_sub(pair, 9,10),
         pair2_spp2=str_sub(pair, 12,13),
         pair2_comp=ifelse(pair2_spp1==pair2_spp2, "intra", "inter"),
         valid=ifelse(pair1_comp=="intra", str_detect(pair2, pair1_spp1), str_detect(pair1, pair2_spp1))) %>% 
  filter(pair1_comp!=pair2_comp, valid==TRUE) %>% 
  mutate(new_pair=ifelse(pair1_comp=="intra", str_c(pair1, pair2, sep=" - "), str_c(pair2, pair1, sep=" - ")),
         r_pair=ifelse(pair1_comp=="intra", r_pair, r_pair*-1),
         .upper=ifelse(pair1_comp=="intra", .upper, .upper*-1),
         .lower=ifelse(pair1_comp=="intra", .lower, .lower*-1)) %>% 
  ggplot(aes(y = new_pair, x = r_pair)) +
  geom_pointintervalh() +
  geom_vline(xintercept=0, linetype="dashed") +
  theme_test() + ylab("Species pair comparisons") + xlab("Synchrony contrast estimate")

mod12 %>% 
  spread_draws(b_Intercept, r_pair[pair,], `r_pair:Region:hilo`[site,]) %>% 
  mutate(spp_mean=b_Intercept + r_pair + `r_pair:Region:hilo`,
         valid=str_detect(site, pair)) %>% 
  filter(valid==1) %>% 
  median_qi(.width = c(.50, .95)) %>%  
  mutate(newsite=str_sub(site, start=7)) %>% 
  ggplot(aes(y=pair, x=spp_mean, xmin=spp_mean.lower, xmax=spp_mean.upper, color=newsite)) +
  geom_pointintervalh(position = position_dodgev(height=0.5)) +
  geom_vline(xintercept=0, linetype="dashed") +
  theme_test() + ylab("") + xlab("Synchrony effect estimate")

mod12 %>% 
  spread_draws(r_pair[pair,], `r_pair:Region:hilo`[site,]) %>% 
  mutate(spp_mean=r_pair + `r_pair:Region:hilo`,
         valid=str_detect(site, pair)) %>% 
  filter(valid==1) %>% 
  mutate(newsite=str_sub(site, start=7)) %>% 
  group_by(newsite) %>% 
  compare_levels(spp_mean, by = pair) %>%
  median_qi(.width = c(.50, .95)) %>%  
  mutate(pair1=str_sub(pair, 1,5),
         pair1_spp1=str_sub(pair, 1,2),
         pair1_spp2=str_sub(pair, 4,5),
         pair1_comp=ifelse(pair1_spp1==pair1_spp2, "intra", "inter"),
         pair2=str_sub(pair, 9,13),
         pair2_spp1=str_sub(pair, 9,10),
         pair2_spp2=str_sub(pair, 12,13),
         pair2_comp=ifelse(pair2_spp1==pair2_spp2, "intra", "inter"),
         valid=ifelse(pair1_comp=="intra", str_detect(pair2, pair1_spp1), str_detect(pair1, pair2_spp1))) %>% 
  filter(pair1_comp!=pair2_comp, valid==TRUE) %>% 
  mutate(new_pair=ifelse(pair1_comp=="intra", str_c(pair1, pair2, sep=" - "), str_c(pair2, pair1, sep=" - ")),
         spp_mean=ifelse(pair1_comp=="intra", spp_mean, spp_mean*-1),
         .upper=ifelse(pair1_comp=="intra", .upper, .upper*-1),
         .lower=ifelse(pair1_comp=="intra", .lower, .lower*-1)) %>% 
  ggplot(aes(y = new_pair, x = spp_mean, color=newsite)) +
  geom_pointintervalh(position = position_dodgev(height=0.5)) +
  geom_vline(xintercept=0, linetype="dashed") +
  theme_test() + ylab("Species pair comparisons") + xlab("Synchrony contrast estimate")

```


## Q3 Synchrony through time
Used 30 year time blocks with a 10 year lag


```{r exploratory}
ggplot(alldata_t, aes(decade, pearson_r, color=Region)) +
  stat_summary(aes(group=interaction(Region, hilo)), geom="pointrange") +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test()

ggplot(alldata_t, aes(decade, pearson_r, color=pair)) +
  stat_summary(aes(group=interaction(pair, hilo)), geom="pointrange") +
  stat_summary(fun.y=mean, aes(group=interaction(pair, hilo), linetype=hilo), geom="line") +
  theme_test() +
  facet_grid(Region~hilo)

ggplot(precip_summary, aes(decade, total_ppt_mm_mean, color=Region)) +
  geom_point() +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test()

ggplot(precip_summary, aes(decade, total_ppt_mm_sd, color=Region)) +
  geom_point()  +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test()

ggplot(precip_summary, aes(decade, spei12_mean, color=Region)) +
  geom_point() +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test()

ggplot(precip_summary, aes(decade, spei12_sd, color=Region)) +
  geom_point()  +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test()

ggplot(precip_summary, aes(decade, mean_temp_C_mean, color=Region)) +
  geom_point() +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test()

ggplot(precip_summary, aes(decade, mean_temp_C_sd, color=Region)) +
  geom_point()  +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test()

```



