---
title: "Synchrony analysis"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "Teresa Bohner"
date: "4/28/2020"
output: 
  html_document:
    toc: true
    collapsed: false
    toc_float: true
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
knitr::opts_chunk$set(fig.path = "figures/")
```

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(brms)
library(tidybayes)
library(viridis)
library(scales)
library(cowplot)
library(patchwork)
library(ggridges)
library(ggstance)
library(modelr)
library(factoextra)
library(ggpmisc)
library(ggrepel)
library(knitr)
library(ggmap)
library(rgdal)
```

## Overview

### Questions
1.  How does synchrony of tree growth vary across regional/elevation gradients?
Prediction: higher synchrony in lower latitude and lower elevation (drier) populations (SIASH, dendrochronological principles)

2.  Within populations is intraspecific synchrony greater than interspecific synchrony? Between specific species pairs? With increasing distance?
Prediction: higher synchrony among intraspecific pairs, potentially higher synchrony between pine pairs versus pine-fir pairs (successional stages), and lower synchrony with increasing distance

3.  How has synchrony changed through time? Are changes more dramatic in certain populations? Is increased or decreased synchrony associated with certain environmental variables?
Prediction: synchrony has increased with time, increased synchrony associated with drier, more variable time windows, changes are more pronounced in xeric populations.

Synchrony is explored here through residual correlations betweeen trees from multivariate models of tree growth.
```{r data}
treeclim <- read.csv("Processed Data/treeclim_spp.csv")

rings_field <- read.csv("Processed Data/matched_rings_field.csv")  %>% 
  group_by(Site, Neighborhood, Species) %>% 
  mutate(comp_BA=BA_con+BA_het) %>%
  arrange(Site, Neighborhood, Species, ID)

spp_site_core <- rings_field %>% 
  group_by(Site, Species, Region, hilo) %>% 
  summarise(n=length(unique(tree.uniqueID)))
  
region <- rings_field %>% 
  ungroup() %>% 
  dplyr::select(c(Site, Region, hilo)) %>% 
  group_by(Site) %>% 
  summarize_all(first) %>% 
  mutate(Region=factor(Region, levels=c("San Jac", "SENF", "SEKI", "Mammoth")))

ids <- ungroup(rings_field) %>% 
  dplyr::select(c(Site, Neighborhood, tree.uniqueID)) %>% 
  group_by(Site, Neighborhood, tree.uniqueID) %>%  summarize_all(first)

tree_data <- rings_field %>% 
  group_by(tree.uniqueID) %>% 
  summarise(DBH=first(DBH),
            comp_BA=first(comp_BA))

precip_order <- data.frame(Site=c("bm", "cm", "lc", "pp", "pr", "sl", "sp"), 
                           precip_order=as.factor(c(3, 6, 4, 5, 7, 1, 2)))
compos <- rings_field %>% 
  group_by(tree.uniqueID, Region, hilo, Site) %>% 
  filter(Site!="ic") %>% 
  summarise(Species=tolower(first(Species))) %>% 
  left_join(precip_order)


site_clim <- read.csv("Processed Data/precip_temp_spei.csv")%>% 
  filter(Site!="ic", Year>1895) %>% 
  dplyr::select(c(Year, Site, Region, hilo, Neighborhood, total_ppt_mm, mean_temp_C, spei12)) %>% #, spei12
  group_by(Site, Region, hilo, Neighborhood, Year) %>% #x
  summarize_all(mean, na.rm=T) %>% 
  group_by(Site, Region, hilo) %>%
  dplyr::select(-c(Neighborhood, Year)) %>%
  summarize_all(list(mean, sd)) %>%
  ungroup() %>% 
  mutate(ppt_cv=total_ppt_mm_fn2/total_ppt_mm_fn1,
         temp_cv=mean_temp_C_fn2/mean_temp_C_fn1)

climdat <- as.matrix(dplyr::select(site_clim, -c(Site, Region, hilo))) 
climdat <- as.matrix(dplyr::select(site_clim, c(total_ppt_mm_fn1, mean_temp_C_fn1))) 
rownames(climdat) <- site_clim$Site
pca <- prcomp(climdat, scale=T)

site_clim <- site_clim %>%  
  mutate(pca1=pca$x[,1],
         pca2=pca$x[,2],
         Region=str_replace(Region, pattern = " ", replacement = "."),
         site=paste(Region, hilo, sep="_"))

precip <- read.csv("Processed Data/precip_temp_spei.csv")

decade <- seq(1910, 2020, by=10)

precip_summary_raw <- expand_grid(precip, decade) %>% 
  filter(Year-decade>-29, Year<=decade) %>% 
  filter(Site!="ic") %>% 
  group_by(Site, siteno, Neighborhood, hilo, decade) %>% 
  summarise_at(vars(total_ppt_mm, mean_temp_C, spei12), list(mean=function(x) mean(x, na.rm=T), sd=function(x) sd(x, na.rm=T), cv=function(x) sd(x, na.rm=T)/mean(x, na.rm=T))) %>% 
  left_join(region) %>% 
  ungroup()

precip_summary <- precip_summary_raw %>% 
  mutate_at(vars(total_ppt_mm_mean, mean_temp_C_mean, spei12_mean, 
                 total_ppt_mm_sd, mean_temp_C_sd, spei12_sd,
                 total_ppt_mm_cv, mean_temp_C_cv, spei12_cv), .funs = function(x) scale(x))

spp_pairs <- expand_grid(Species.x=c("ac", "pj", "pl", "pp"), Species.y=c("ac", "pj", "pl", "pp")) %>% 
  mutate(pair_first=str_c(Species.x, Species.y, sep="-"),
         pair=c("ac-ac", "ac-pj", "ac-pl", "ac-pj", "ac-pj", "pj-pj", "pj-pl", "pj-pp", 
                      "ac-pl", "pj-pl", "pl-pl", "pl-pp", "ac-pp", "pj-pp", "pl-pp", "pp-pp")) %>% 
  dplyr::select(-c(pair_first))

pearson <- read.csv("Processed Data/synchrony_dat.csv") %>% 
  na.omit() %>% 
  filter(Site.x !="ic") %>% 
  mutate_at(vars(Species.x, Species.y), tolower) %>% 
  left_join(spp_pairs) %>% 
  mutate(spp1=str_sub(pair, 1,2),
         spp2=str_sub(pair, 4,5),
         comp=ifelse(Species.x==Species.y, "intra", "inter"))

site_corr <- pearson %>% 
  na.omit() %>% 
  filter(Site.x !="ic") %>% 
  group_by(Site.x) %>% 
  summarise(site_r=mean(pearson_r)) %>% 
  left_join(site_clim, by=c("Site.x"="Site")) 


pearson_t <- read.csv("Processed Data/synchrony_decadal_pearson.csv") %>% 
  na.omit() %>% 
  filter(Site.x !="ic") %>% 
  mutate_at(vars(Species.x, Species.y), tolower) %>% 
  left_join(spp_pairs) %>% 
  mutate(spp1=str_sub(pair, 1,2),
         spp2=str_sub(pair, 4,5),
         comp=ifelse(Species.x==Species.y, "intra", "inter"))
summary_t <- pearson_t %>% 
  dplyr::select(c(pearson_r, decade, Site.x, Neighborhood.x, pair, comp)) %>% 
  group_by(Site.x, Neighborhood.x, pair, comp, decade) %>% #
  summarise(samp.depth=length(pearson_r),
            pearson_sd=sd(pearson_r, na.rm=T),
            pearson_r=mean(pearson_r, na.rm=T)) %>% 
  left_join(precip_summary, by=c("Site.x"="Site", "Neighborhood.x"="Neighborhood", "decade")) #

## join all data ----
alldata <- pearson %>% 
  left_join(tree_data, by=c("tree2"="tree.uniqueID")) %>% 
  mutate(sizeratio=ifelse(DBH.x>DBH.y, DBH.x/DBH.y, DBH.y/DBH.x),
         realsizeratio=sizeratio,
         realdist=dist,
         Region=factor(Region, levels=c("San Jac", "SENF", "SEKI", "Mammoth"))) %>% 
  mutate_at(vars(dist, sizeratio, comp_BA), scale)

alldata_t <- pearson_t %>% 
  left_join(tree_data, by=c("tree2"="tree.uniqueID")) %>% 
  mutate(sizeratio=ifelse(DBH.x>DBH.y, DBH.x/DBH.y, DBH.y/DBH.x),
         Region=factor(Region, levels=c("San Jac", "SENF", "SEKI", "Mammoth"))) %>% 
  mutate_at(vars(dist, sizeratio, comp_BA), scale) %>% 
  left_join(dplyr::select(precip_summary, -c(Region, hilo)), by=c('Site.x'='Site', 'decade'='decade'))

  
```
```{r map}
states <- readOGR("Raw Data/cb_2016_us_state_500k/cb_2016_us_state_500k.shp")
states1 <-  states[states$NAME=="California",]
states.f <- fortify(states1, regions="STUSPS")

sites <- read.csv("Raw Data/locations for prism.csv") %>% 
  mutate(Site=str_sub(Site, 1, 2)) %>% 
  inner_join(region) %>% 
  filter(Site!="ic")
  

raw_clim <- read.csv("Processed Data/precip_temp_spei.csv") %>% 
  filter(Year>1895, Site!="ic") %>% 
  mutate(Region=factor(Region, levels=c("Mammoth", "SEKI", "SENF", "San Jac"))) 

reg_clim <- raw_clim %>% 
  group_by(Region, Year) %>% 
  summarize(spei12=mean(spei12, na.rm=T),
            total_ppt_mm=mean(total_ppt_mm),
            mean_temp_C=mean(mean_temp_C))
  
avg_clim <- raw_clim %>% 
  group_by(Region, hilo) %>% 
  summarize(Latitude=mean(Latitude),
            Longitude=mean(Longitude),
            avg_ppt=mean(total_ppt_mm),
            avg_temp=mean(mean_temp_C),
            avg_spei=mean(spei12, na.rm=T))

myLocation <- c(-129, 30, -112, 45)

myLocation <- "Sequoia National Monument"

myMap <- get_map(location=myLocation,
                 source="google", maptype="satellite", crop=FALSE, zoom=7)
ggmap(myMap) +
  # geom_polygon(data=states.f, aes(long,lat, group=group),color="black", fill=NA) +
  geom_point(data=sites, aes(X, Y, color=Region), size=2) +
  scale_color_viridis(option='plasma', discrete=T) +
  labs(x = 'Longitude', y = 'Latitude') +
  theme_test() +
  labs(color="") +
  # theme(legend.position = 'none') +
  ggtitle("")

ggplot(avg_clim, aes(avg_temp, avg_ppt, color=Region, shape=hilo)) +
  geom_point(size=3) +
  scale_color_viridis(option='plasma', discrete=T, direction = -1) +
  theme_test() +
  xlab("Mean temperature (C)") +
  ylab("Mean precipitation (mm)") +
  # theme(legend.position = 'none') +
  theme(legend.title = element_blank()) +
  ggtitle("") +
  theme(axis.title=element_text(size=14))
```
## Q2 Intra-interspecific competition

### Pairwise pearson correlation summaires: 
We calculated the correlation between series of tree ring growth for all unique pairs of individuals within competitive neighborhoods. 
``` {r funs_and_manip}
## function to extract data at the species level----
spp_subsetter <- function(data, sp) {
  a <- filter(data, pair==paste(sort(c(sp, "ac")), collapse="-")) %>%
    mutate(focal_sp=sp,
           comp_sp="ac")
  b <- filter(data, pair==paste(sort(c(sp, "pj")), collapse="-")) %>%
    mutate(focal_sp=sp,
           comp_sp="pj")
  c <- filter(data, pair==paste(sort(c(sp, "pl")), collapse="-")) %>%
    mutate(focal_sp=sp,
           comp_sp="pl")
  d <- filter(data, pair==paste(sort(c(sp, "pp")), collapse="-")) %>%
    mutate(focal_sp=sp,
           comp_sp="pp")
  
  bind_rows(a,b,c,d) %>%
    mutate(comp_sp=ifelse(comp_sp==focal_sp, "self", comp_sp))
}

## summary data for median correlation
summary <- group_by(alldata, spp1, spp2, pair) %>% 
  summarise(med=median(pearson_r),
            mean=mean(pearson_r),
            sd=sd(pearson_r))
print(summary)

## subset species----
acdat <- spp_subsetter(alldata, "ac")
pjdat <- spp_subsetter(alldata, "pj")
pldat <- spp_subsetter(alldata, "pl")
ppdat <- spp_subsetter(alldata, "pp")


```



```{r fig_inter_intra}
# show_col(viridis_pal()(5)) # get the hex codes for the colors
#440154FF
cols <- c("self"="#440154FF", "ac"="#3B528BFF", "pj"="#21908CFF", "pl"="#5DC863FF", "pp"="#FDE725FF") ## keep species cols consistent
ggplot(compos, aes(precip_order, fill=Species)) +
  geom_bar(aes(fill=Species), position = "fill") +
  scale_fill_manual(values=cols, labels = c("A. concolor", "P. jeffreyi", "P. lambertiana", "P. ponderosa","self")) +
  theme_test() +
  ylab("Proportion of samples") +
  xlab("Site (ordered from lowest to highest annual precipitation)") +
  theme(legend.text=element_text(face="italic")) +
  theme(axis.title=element_text(size=14))

## matrix style figure
# ggplot(alldata, aes(pearson_r, fill=comp)) +
#   geom_density(aes(y = ..scaled..), alpha=0.5) +
#   facet_grid(spp2~spp1) +
#   theme_test() +
#   geom_vline(data=summary, aes(xintercept=med), linetype="dashed") +
#   ylab("proportion") + xlab("pearson correlation")


p1 <- ggplot(acdat, aes(pearson_r, color=comp_sp, fill=comp_sp)) +
  geom_density(position = "identity", alpha=0.5) +
  theme_test() +
  ggtitle("A. concolor") +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  theme(legend.position = 'none') +
  xlab("Pearson correlation") +
  xlim(c(-0.5, 1)) +
  theme(plot.title =  element_text(size = 12))

p2 <- ggplot(pjdat, aes(pearson_r, color=comp_sp, fill=comp_sp)) +
  geom_density(position = "identity", alpha=0.5) +
  theme_test() +
  ggtitle("P. jeffreyi") +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  theme(legend.position = 'none') +
  xlab("Pearson correlation") +
  xlim(c(-0.5, 1)) +
  theme(plot.title =  element_text(size = 12))

p3 <- ggplot(pldat, aes(pearson_r, color=comp_sp, fill=comp_sp)) +
  geom_density(position = "identity", alpha=0.5) +
  theme_test() +
  ggtitle("P. lambertiana") +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  theme(legend.position = 'none') +
  xlab("Pearson correlation") +
  xlim(c(-0.5, 1)) +
  theme(plot.title =  element_text(size = 12))

p4 <- ggplot(ppdat, aes(pearson_r, color=comp_sp, fill=comp_sp)) +
  geom_density(position = "identity", alpha=0.5) +
  theme_test() +
  ggtitle("P. ponderosa") +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  theme(legend.position = 'none') +
  xlab("Pearson correlation") +
  xlim(c(-0.5, 1)) +
  theme(plot.title =  element_text(size = 12))

dummy <- ggplot(bind_rows(acdat, pjdat), aes(pearson_r, color=comp_sp, fill=comp_sp)) +
  geom_density(alpha=0.5) +
  theme_test() +
  scale_fill_manual(values=cols, labels = c("A. concolor", "P. jeffreyi", "P. lambertiana", "P. ponderosa","self")) +
  scale_color_manual(values=cols, labels = c("A. concolor", "P. jeffreyi", "P. lambertiana", "P. ponderosa","self")) +
  labs(fill = "Competitor", color="Competitor") +
  theme(legend.text=element_text(face="italic"))

legend <- cowplot::get_legend(dummy)
# plot_grid(legend)

plot_grid(plot_grid(p1,p2,p3,p4, ncol=2), legend, ncol=2, rel_widths = c(1,.2))
```

### Correlation response model: 
We wanted to data the relationship between the pairwise correlations and distance, size ratios, species-pairs, and locations of all of the trees. We built hierarchical mixed models with the pairwise correlations as a responses (normal truncated response (-1,1)). 

```{r sync_mixed_model}
mod12 <- readRDS("saved models/pearson models/mod12.rds")
mod12
```
```{r fig_dist}
dist_summ <- dplyr::select(alldata, c(dist, realdist, sizeratio)) %>%
  mutate(sizeratio=quantile(sizeratio, probs=0.5)) %>%
  add_fitted_draws(model=mod12, re_formula=NA) %>%
  median_qi()

ggplot() +
  geom_point(data=alldata, aes(realdist, pearson_r))+
  scale_color_viridis(option='magma', direction = -1) +
  geom_line(data=dist_summ, aes(realdist, .value)) +
  geom_ribbon(data=dist_summ, aes(realdist, ymin=.lower, ymax=.upper), alpha=0.3) +
  theme_test() +
  xlab("Distance (m)") + ylab("Estimated correlation") +
  ggtitle("") +
  theme(plot.margin = unit(c(0,0,0,0), "cm")) +
  theme(axis.title=element_text(size=14))


```

```{r fig_spp_pairs}

mod12 %>% 
  spread_draws(b_Intercept, r_pair[pair,]) %>% 
  mutate(spp_mean=b_Intercept + r_pair) %>% 
  dplyr::select(-c(b_Intercept, r_pair)) %>% 
  median_qi(.width = c(.95)) %>% #.50, 
  dplyr::select(-c(.point, .interval)) %>% 
  # ggplot(aes(y=pair, x=spp_mean, xmin=.lower, xmax=.upper)) +
  # geom_pointintervalh() +
  # geom_vline(xintercept=0, linetype="dashed") +
  # theme_test() + ylab("") + xlab("Synchrony effect estimate") +
  # labs(caption="Fig. Variation in effect of species pairing on synchrony") +
  # theme(plot.caption = element_text(hjust = 0)) 
  kable("pandoc", caption = "Species pair intercepts")

spp_summ <- expand_grid(pair=unique(alldata$pair), 
                        sizeratio=quantile(alldata$sizeratio, probs=0.5),
                        dist=quantile(alldata$dist, probs=0.5)) %>%
  add_fitted_draws(model=mod12, re_formula=~(1|pair)) %>%
  median_qi(.width = c(.50, .95))

spp_summ %>% 
  ungroup() %>% 
  filter(.width==0.95) %>% 
  dplyr::select(-c(sizeratio, dist, .row, .point, .interval)) %>% 
  kable("pandoc", caption = "Conditional species pair estimates")
    
# ggplot(data=spp_summ, aes(y=pair, x=.value, xmin=.lower, xmax=.upper)) +
#   geom_pointintervalh() +
#   geom_vline(xintercept=0, linetype="dashed") +
#   theme_test() + ylab("") + xlab("Synchrony effect estimate") +
#   labs(caption="Fig. Variation in effect of species pairing on synchrony") +
#   theme(plot.caption = element_text(hjust = 0))


contrasts <- mod12 %>% 
  spread_draws(r_pair[pair,]) %>% 
  compare_levels(r_pair, by = pair) %>%
  median_qi(.width = c(.50, .95)) %>% 
  mutate(pair1=str_sub(pair, 1,5),
         pair1_spp1=str_sub(pair, 1,2),
         pair1_spp2=str_sub(pair, 4,5),
         pair1_comp=ifelse(pair1_spp1==pair1_spp2, "intra", "inter"),
         pair2=str_sub(pair, 9,13),
         pair2_spp1=str_sub(pair, 9,10),
         pair2_spp2=str_sub(pair, 12,13),
         pair2_comp=ifelse(pair2_spp1==pair2_spp2, "intra", "inter"),
         valid=ifelse(pair1_comp=="intra", str_detect(pair2, pair1_spp1), str_detect(pair1, pair2_spp1))) %>% 
  filter(pair1_comp!=pair2_comp, valid==TRUE) %>% 
  mutate(new_pair=ifelse(pair1_comp=="intra", str_c(pair1, pair2, sep=" - "), str_c(pair2, pair1, sep=" - ")),
         new_inter1=str_sub(new_pair, start=9,10),
         new_inter2=str_sub(new_pair, start=12,13),
         intra_spp=str_sub(new_pair, start=1, 2),
         comp_spp=ifelse(str_detect(new_inter1, intra_spp), new_inter2, new_inter1),
         r_pair=ifelse(pair1_comp=="intra", r_pair, r_pair*-1),
         .upper=ifelse(pair1_comp=="intra", .upper, .upper*-1),
         .lower=ifelse(pair1_comp=="intra", .lower, .lower*-1))

# test <- group_by(contrasts, pair) %>% 
#   summarise(post=length(which(r_pair>0))/length(r_pair),
#             CI=1-2*(1-post))

i1 <- ggplot(data=filter(contrasts, intra_spp=="ac"),
       aes(y = new_pair, x = r_pair, color=comp_spp)) +
  geom_pointintervalh() +
  geom_vline(xintercept=0, linetype="dashed") +
  scale_color_manual(values=cols) +
  theme_test() + ylab("Species pair comparisons") + xlab("Synchrony contrast estimate") +
  theme(legend.position = 'none') +
  theme(axis.title=element_blank()) +
  ggtitle("") +
  theme(axis.text.y=element_blank()) +
  theme(plot.margin = unit(c(0.1,0,0,.5), "cm")) +
  ggtitle("A. concolor") +
  theme(plot.title=element_text(size=10, face='italic'))

i2 <- ggplot(data=filter(contrasts, intra_spp=="pj"),
       aes(y = new_pair, x = r_pair, color=comp_spp)) +
  geom_pointintervalh() +
  geom_vline(xintercept=0, linetype="dashed") +
  scale_color_manual(values=cols) +
  theme_test() + ylab("Species pair comparisons") + xlab("Synchrony contrast estimate")+
  theme(legend.position = 'none') +
  theme(axis.title=element_blank()) +
  ggtitle("") +
  theme(axis.text.y=element_blank()) +
  theme(plot.margin = unit(c(0.1,0,0,.5), "cm"))+
  ggtitle("P. jeffreyi") +
  theme(plot.title=element_text(size=10, face='italic'))

i3 <- ggplot(data=filter(contrasts, intra_spp=="pl"),
       aes(y = new_pair, x = r_pair, color=comp_spp)) +
  geom_pointintervalh() +
  geom_vline(xintercept=0, linetype="dashed") +
  scale_color_manual(values=cols) +
  theme_test() + ylab("Species pair comparisons") + xlab("Synchrony contrast estimate")+
  theme(legend.position = 'none') +
  theme(axis.title=element_blank()) +
  ggtitle("") +
  theme(axis.text.y=element_blank()) +
  theme(plot.margin = unit(c(0.1,0,0,.5), "cm"))+
  ggtitle("P. lambertiana") +
  theme(plot.title=element_text(size=10, face='italic'))

i4 <- ggplot(data=filter(contrasts, intra_spp=="pp"),
       aes(y = new_pair, x = r_pair, color=comp_spp)) +
  geom_pointintervalh() +
  geom_vline(xintercept=0, linetype="dashed") +
  scale_color_manual(values=cols) +
  theme_test() + ylab("Species pair comparisons") + xlab("Intra- versus inter-specific contrast")+
  theme(legend.position = 'none') +
  theme(axis.title.y=element_blank()) +
  ggtitle("") +
  theme(axis.text.y=element_blank()) +
  theme(plot.margin = unit(c(0.1,0,0,0.5), "cm"))+
  ggtitle("P. ponderosa") +
  theme(plot.title=element_text(size=10, face='italic'))


p1a <- p1 +
  # ggtitle("") +
  theme(axis.title=element_blank()) +
  theme(plot.margin = unit(c(0.1,0,0,.5), "cm")) +
  theme(plot.title=element_text(size=10, face='italic'))
p2a <- p2 +
  # ggtitle("") +
  theme(axis.title=element_blank()) +
  theme(plot.margin = unit(c(0.1,0,0,.5), "cm")) +
  theme(plot.title=element_text(size=10, face='italic'))
p3a <- p3 +
  # ggtitle("") +
  theme(axis.title=element_blank()) +
  theme(plot.margin = unit(c(0.1,0,0,.5), "cm")) +
  theme(plot.title=element_text(size=10, face='italic'))
p4a <- p4 +
  # ggtitle("") +
  theme(axis.title.y=element_blank()) +
  theme(plot.margin = unit(c(0.1,0,0,.5), "cm")) +
  theme(plot.title=element_text(size=10, face='italic'))


# plot_grid(
#   plot_grid(p1a, i1, p2a, i2, p3a, i3, p4a, i4, ncol=2, align='vh', labels='auto', label_x = 0, label_y = 1,
#   hjust = -0.5, vjust = 1),
#   legend, ncol=2, rel_widths = c(1,0.15))

plot_grid(
  plot_grid(
    plot_grid(p1a, i1, p2a, i2, p3a, i3, ncol=2, align='vh', labels=c('a', 'b'), label_x = 0, label_y = 1,
  hjust = -2, vjust = 1),
  plot_grid(p4a, i4, ncol=2, align='vh'), ncol=1, align='vh', rel_heights = c(1, 0.36)),
  legend, ncol=2, rel_widths = c(1,0.2))

```
```{r fig_site_diff}
# fviz_pca_ind(pca,
#              col.ind = "cos2", # Color by the quality of representation
#              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
#              repel = TRUE     # Avoid text overlapping
#              )
# 
# fviz_pca_var(pca,
#              col.var = "contrib", # Color by contributions to the PC
#              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
#              repel = TRUE     # Avoid text overlapping
#              )


data <- mod12 %>% 
  spread_draws(b_Intercept, `r_Region:hilo`[site,]) %>% 
  mutate(mean=b_Intercept + `r_Region:hilo`) %>% 
  median_qi(.width=c(0.95)) %>% 
  left_join(site_clim) %>% 
  mutate(Region=factor(Region, levels=c("San.Jac", "SENF", "SEKI", "Mammoth")))

# data %>% ggplot(aes(y=site, x=mean, xmin=mean.lower, xmax=mean.upper, color=site)) +
#   geom_pointintervalh(position = position_dodgev(height=0.5)) +
#   geom_vline(xintercept=0, linetype="dashed") +
#   theme_test() + ylab("") + xlab("Synchrony effect estimate") +
#   labs(caption="Fig. Variation in effect of species pairing on synchrony including region and elevation variation") +
#   theme(plot.caption = element_text(hjust = 0))

data %>% 
  dplyr::select(Region, hilo, mean, mean.lower, mean.upper, .width) %>% 
  filter(.width==0.95) %>% 
  kable("pandoc", caption = "Site intercepts")

site_summ <- expand_grid(dplyr::select(data, c(Region, hilo)),
                        sizeratio=quantile(alldata$sizeratio, probs=0.5),
                        dist=quantile(alldata$dist, probs=0.5)) %>%
  mutate(Region=ifelse(Region=="San.Jac", "San Jac", as.character(Region))) %>% 
  add_fitted_draws(model=mod12, re_formula=~(1|Region:hilo)) %>%
  median_qi(.width = c(.95)) %>% 
  ungroup() %>% 
  mutate(Region=ifelse(Region=="San Jac", "San.Jac", as.character(Region))) %>% 
  left_join(site_clim) 

site_summ %>% 
  ungroup() %>% 
  filter(.width==0.95) %>% 
  dplyr::select(-c(sizeratio, dist, .row, .point, .interval)) %>% 
  kable("pandoc", caption = "Conditional species pair estimates")

summary(lm(data$mean~data$total_ppt_mm_fn1))
summary(lm(site_summ$.value~site_summ$total_ppt_mm_fn1))


ggplot(data, aes(total_ppt_mm_fn1, mean)) + 
  geom_smooth(method='lm') +
  geom_point(data=site_corr, aes(total_ppt_mm_fn1, site_r), alpha=0.5, size=2) +
  geom_point(aes(color=Region)) + 
  geom_text_repel(aes(label=paste(Region, hilo), color=Region)) +
  # stat_fit_tb(tb.vars = c(Effect = "term", Estimate='estimate', "italic(F)" = "statistic", "italic(P)" = "p.value"),
  #             parse = TRUE)
  stat_fit_glance(method = "lm",
                  label.y = "bottom",
                  mapping = aes(label = sprintf('R^2~"="~%.3f~~italic(P)~"="~%.2g',
                                stat(r.squared), stat(p.value))),
                  parse = TRUE) +
  scale_color_viridis(option='plasma', discrete=T) +
  theme_test() + xlab("Mean total annual precipitation (mm)") +
  ylab("Estimated synchrony") +
  theme(legend.position='none') +
  theme(axis.title=element_text(size=14))

newdata <- summary_t %>%
  group_by(Region, hilo, pair) %>%
  summarise()

site_sp_summ <- expand_grid(newdata, 
                        sizeratio=quantile(alldata$sizeratio, probs=0.5),
                        dist=quantile(alldata$dist, probs=0.5)) %>%
  add_fitted_draws(model=mod12, re_formula=~(1|pair/Region:hilo)) %>%
  median_qi(.width = c(.95)) %>% 
  ungroup() %>% 
  mutate(Region=ifelse(Region=="San Jac", "San.Jac", as.character(Region))) %>% 
  left_join(site_clim) 

intra_sub <- filter(site_sp_summ, pair%in%c("ac-ac", "pj-pj", "pl-pl"))

mod <- lm(.value~pair*total_ppt_mm_fn1, data=site_sp_summ)
anova(mod)

# site_sp_summ %>%
#   ggplot(aes(y=pair, x=.value, xmin=.lower, xmax=.upper, color=site)) +
#   geom_pointintervalh(position = position_dodgev(height=0.5)) +
#   geom_vline(xintercept=0, linetype="dashed") +
#   theme_test() + ylab("") + xlab("Synchrony effect estimate") +
#   labs(caption="Fig. Variation in effect of species pairing on synchrony including region and elevation variation") +
#   theme(plot.caption = element_text(hjust = 0))

ggplot(site_sp_summ, aes(total_ppt_mm_fn1, .value, color=pair)) + 
  geom_point(aes()) + 
  # geom_text_repel(aes(label=paste(Region, hilo))) +
  geom_smooth(method='lm') +
  # stat_fit_tb(tb.vars = c(Effect = "term", Estimate='estimate', "italic(F)" = "statistic", "italic(P)" = "p.value"),
  #             parse = TRUE)
  # stat_fit_glance(method = "lm",
  #                 label.y = "bottom",
  #                 mapping = aes(label = sprintf('R^2~"="~%.3f~~italic(P)~"="~%.2g',
  #                               stat(r.squared), stat(p.value))),
  #                 parse = TRUE) +
  scale_color_viridis( discrete=T) +
  theme_test() + xlab("Mean total annual precipitation (mm)") +
  ylab("Estimated synchrony") +
  theme(axis.title=element_text(size=14))


data <- mod12 %>%
  spread_draws(b_Intercept, r_pair[pair,], `r_pair:Region:hilo`[pair_site,], `r_Region:hilo`[site,]) %>%
  mutate(spp_mean=b_Intercept + r_pair + `r_pair:Region:hilo` + `r_Region:hilo`,
         valid=str_detect(pair_site, pair)&str_detect(pair_site, site)) %>%
  filter(valid==1) %>%
  median_qi(.width = c(.50, .95))

# data %>%
#   ggplot(aes(y=pair, x=spp_mean, xmin=spp_mean.lower, xmax=spp_mean.upper, color=site)) +
#   geom_pointintervalh(position = position_dodgev(height=0.5)) +
#   geom_vline(xintercept=0, linetype="dashed") +
#   theme_test() + ylab("") + xlab("Synchrony effect estimate") +
#   labs(caption="Fig. Variation in effect of species pairing on synchrony including region and elevation variation") +
#   theme(plot.caption = element_text(hjust = 0))

data2 <- mod12 %>%
  spread_draws(b_Intercept,`r_Region:hilo`[site,]) %>%
  mutate(site_mean=b_Intercept + `r_Region:hilo`) %>% 
  dplyr::select(site, site_mean) %>%
  median_qi(.width = c(.50, .95))


ggplot(data, aes(y=site, x=spp_mean)) +
  geom_pointintervalh(aes(xmin=spp_mean.lower, xmax=spp_mean.upper, color=pair), position = position_dodgev(height=0.5)) +
  scale_color_viridis(discrete=T) +
  geom_pointintervalh(data=data2, aes(x = site_mean, y=site, xmax=.upper, xmin=.lower), position = position_nudge(y = -0.4), shape=15, size_domain=c(0.5,3.5)) +
  geom_vline(xintercept=0, linetype="dashed") +
  theme_test() + ylab("") + xlab("Synchrony effect estimate") +
  theme(plot.caption = element_text(hjust = 0)) +
  theme(legend.title = element_blank()) +
  theme(axis.title=element_text(size=14))
# 
# 
data <- mod12 %>%
  spread_draws(b_Intercept, r_pair[pair,], `r_pair:Region:hilo`[pair_site,], `r_Region:hilo`[site,]) %>%
  mutate(spp_mean=b_Intercept + r_pair + `r_pair:Region:hilo` + `r_Region:hilo`,
         valid=str_detect(pair_site, pair)&str_detect(pair_site, site)) %>%
  filter(valid==1) %>%
  group_by(site) %>%
  compare_levels(spp_mean, by = pair) %>%
  median_qi(.width = c(.50, .95)) %>%
  mutate(pair1=str_sub(pair, 1,5),
         pair1_spp1=str_sub(pair, 1,2),
         pair1_spp2=str_sub(pair, 4,5),
         pair1_comp=ifelse(pair1_spp1==pair1_spp2, "intra", "inter"),
         pair2=str_sub(pair, 9,13),
         pair2_spp1=str_sub(pair, 9,10),
         pair2_spp2=str_sub(pair, 12,13),
         pair2_comp=ifelse(pair2_spp1==pair2_spp2, "intra", "inter"),
         valid=ifelse(pair1_comp=="intra", str_detect(pair2, pair1_spp1), str_detect(pair1, pair2_spp1))) %>%
  filter(pair1_comp!=pair2_comp, valid==TRUE) %>%
  mutate(new_pair=ifelse(pair1_comp=="intra", str_c(pair1, pair2, sep=" - "), str_c(pair2, pair1, sep=" - ")),
         spp_mean=ifelse(pair1_comp=="intra", spp_mean, spp_mean*-1),
         .upper=ifelse(pair1_comp=="intra", .upper, .upper*-1),
         .lower=ifelse(pair1_comp=="intra", .lower, .lower*-1))
  
data <- data %>% 
  mutate(col_sp=str_sub(new_pair, 1,2),
         comp_sp=str_replace_all(new_pair, col_sp, ""),
         comp_sp=str_squish(str_replace_all(comp_sp, "-", ""))) 
# 
# ggplot(data, aes(y = site, x = spp_mean, group=new_pair, color=col_sp)) +
#   geom_pointintervalh(position = position_dodgev(height=0.5)) +
#   geom_vline(xintercept=0, linetype="dashed") +
#   theme_test() + ylab("Species pair comparisons") + xlab("Synchrony contrast estimate") +
#   labs(caption="Fig. Contrast in intra versus interspecific synchrony effect including region and elevation variation. Positive \n contrasts indicate thatintraspecific synchrony is greater than interspecific. Species level patterns in differentiation \n predominate although there is noteworthy variation among sites.") +
#   theme(plot.caption = element_text(hjust = 0))

library(RColorBrewer)
mypal <- colorRampPalette(brewer.pal(9, "Purples"))
mypal2 <- colorRampPalette(brewer.pal(7, "YlGn"))
mypal3 <- colorRampPalette(brewer.pal(5, "OrRd"))
mypal4 <- colorRampPalette(brewer.pal(6, "GnBu"))
# show_col(c(mypal(4), mypal2(4), mypal3(4), mypal4(4)))

pal <- c(mypal(4)[2:4],mypal2(4)[2:4],mypal3(4)[2:4],mypal4(4)[2:4])
# show_col(pal)


ggplot(data, aes(y = site, x = spp_mean, group=new_pair, color=interaction(comp_sp, col_sp))) +
  geom_pointintervalh(position = position_dodgev(height=0.5)) +
  geom_vline(xintercept=0, linetype="dashed") +
  theme_test() + ylab("Species pair comparisons") + xlab("Synchrony contrast estimate") +
  labs(caption="Fig. Contrast in intra versus interspecific synchrony effect including region and elevation variation. Positive \n contrasts indicate thatintraspecific synchrony is greater than interspecific. Species level patterns in differentiation \n predominate although there is noteworthy variation among sites.") +
  theme(plot.caption = element_text(hjust = 0))+
  scale_colour_manual(values = pal)


```


## Q3 Synchrony through time
### Pairwise pearson correlations through time:
We calculated pearson correlations between pairs of individuals within neighborhoods for 30 year time blocks with a 10 year lag to measure synchrony through time. Trends were analyzed for data summarized for species-pairs at the neighborhood level. Note this is measuring within population synchrony (in contrast to Shestakova spatial synchrony).


```{r exploratory}
ggplot(alldata_t, aes(decade, pearson_r, color=Region)) +
  stat_summary(aes(group=interaction(Region, hilo)), geom="pointrange") +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test() +
  labs(caption="Fig. Growth synchrony through time.") +
  theme(plot.caption = element_text(hjust = 0))

ggplot(alldata_t, aes(decade, pearson_r, color=pair)) +
  stat_summary(aes(group=pair), geom="pointrange") +
  stat_summary(fun.y=mean, aes(group=pair), geom="line") +
  theme_test() +
  labs(caption="Fig. Growth synchrony through time.") +
  theme(plot.caption = element_text(hjust = 0))


spei_a <- ggplot(precip_summary_raw, aes(decade, spei12_mean, color=Region)) +
  geom_point() +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test() + theme(legend.position = 'none')

spei_b <- ggplot(precip_summary_raw, aes(decade, spei12_sd, color=Region)) +
  geom_point()  +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test() + theme(legend.position = 'none')

# now add the title
caption <- ggdraw() + 
  draw_label(
    "Fig. mean annual SPEI and SD for the 30 year blocks. ",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
plot_grid(
  plot_grid(spei_a, spei_b, ncol=2, labels = "auto"), caption, 
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(1, .1)
)


precip_a <- ggplot(precip_summary_raw, aes(decade, total_ppt_mm_mean, color=Region)) +
  geom_point()  +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test() + theme(legend.position = 'none')
precip_b <- ggplot(precip_summary_raw, aes(decade, total_ppt_mm_cv, color=Region)) +
  geom_point() +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test() + theme(legend.position = 'none')

caption <- ggdraw() + 
  draw_label(
    "Fig. mean total annual precipitation (mm) and CV for the 30 year blocks. ",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
plot_grid(
  plot_grid(precip_a, precip_b, ncol=2, labels = "auto"), caption, 
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(1, .1)
)


a <- ggplot(precip_summary_raw, aes(decade, mean_temp_C_mean, color=Region)) +
  geom_point() +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test() + theme(legend.position = 'none')

b <- ggplot(precip_summary_raw, aes(decade, mean_temp_C_cv, color=Region)) +
  geom_point()  +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), linetype=hilo), geom="line") +
  theme_test() + theme(legend.position = 'none')

caption <- ggdraw() + 
  draw_label(
    "Fig. mean annual temp (C) and CV for the 30 year blocks. ",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
plot_grid(
  plot_grid(a, b, ncol=2, labels = "auto"), caption, 
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(1, .1)
)

```


### Spline model:
I wanted to explore fitting a spline model to look at nonlinear changes in synchrony over time for different species-pairs and at different sites.
```{r spline_model}
# spline_mod <- readRDS("saved models/spline_site.rds")
spline_mod <- readRDS("saved models/spline.rds")
print(spline_mod$formula)
me <- marginal_effects(spline_mod)

ggplot(me$decade, aes(decade, estimate__)) +
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.3) +
   geom_line() + theme_test() + ylab("Expected correlation") + 
  labs(caption="Fig. Overall synchrony has increased through time.") +
  theme(plot.caption = element_text(hjust = 0))

s1 <- ggplot(alldata_t, aes(decade, pearson_r)) +
  geom_ribbon(data=me$decade, aes(ymin=lower__, ymax=upper__), alpha=0.3) +
  geom_line(data=me$decade, aes(decade, estimate__)) +
  # geom_ribbon(data=me$`decade:pair`, aes(ymin=lower__, ymax=upper__, fill=tolower(pair)), alpha=0.3) +
  # geom_line(data=me$`decade:pair`, aes(decade, estimate__, color=tolower(pair))) +
  stat_summary(aes(group=pair, color=pair), geom="pointrange") +
  stat_summary(fun.y=mean, aes(group=pair, color=pair), geom="line") +
  theme_test() +
  ylab("Correlation") +
  xlab("Decade") +
  scale_color_viridis(discrete=T, name='') +
  theme(legend.position = 'bottom') +
  ggtitle("") +
  theme(plot.margin = unit(c(0,0,0,0), "cm"))

site_time_grow <- ggplot(alldata_t, aes(decade, pearson_r)) +
  stat_summary(aes(group=interaction(Region, hilo), color=Region), geom="pointrange") +
  stat_summary(fun.y=mean, aes(group=interaction(Region, hilo), color=Region, linetype=hilo), geom="line") +
  theme_test() +
  ylab("Correlation") +
  xlab("Decade") +
  scale_color_viridis(discrete=T, name='', option='plasma') +
  guides(linetype=guide_legend(title ='', nrow = 2), color=guide_legend( nrow = 2)) +
  theme(legend.position = 'bottom') +
  ggtitle("") +
  theme(plot.margin = unit(c(0,0,0,0), "cm"))

s1b <- site_time_grow +
  geom_ribbon(data=me$decade, aes(ymin=lower__, ymax=upper__), alpha=0.3) +
  geom_line(data=me$decade, aes(decade, estimate__)) 
  # geom_ribbon(data=me$`decade:pair`, aes(ymin=lower__, ymax=upper__, fill=tolower(pair)), alpha=0.3) +
  # geom_line(data=me$`decade:pair`, aes(decade, estimate__, color=tolower(pair))) 

overall <- data.frame(decade=unique(summary_t$decade)) %>%
  add_fitted_draws(spline_mod, re_formula = NULL, allow_new_levels=TRUE) %>% 
  median_qi(.width=c(0.5, 0.95))  %>% 
  mutate(pair="Overall",
         overall="yes",
         timechunk=ifelse(decade<1970, "early", "late")) %>% 
  ungroup() %>% 
  dplyr::select(-decade, -.row) %>% 
  group_by(pair, overall, timechunk, .width, .point, .interval) %>% 
  summarise_all(mean)

s2 <-ggplot(overall, aes(x=.value, y=pair, color=timechunk)) +
  geom_pointintervalh(position = position_dodgev(height=0.5)) + theme_test() +
  geom_vline(xintercept = 0, linetype="dashed")  +
  xlab("Expected correlation") + ylab("") + ggtitle("") +
  scale_color_viridis(discrete = T, option='magma', begin = 0, end=0.4, name = "", labels = c("pre-1970", "post-1970")) + theme(legend.position = 'none', axis.title.x = element_blank()) +
  theme(plot.margin = unit(c(0,0,0,0), "cm"))

```

```{r spline_mod_spp}
spline_mod <- readRDS("saved models/spline_spp.rds")
print(spline_mod$formula)
me <- marginal_effects(spline_mod)

ggplot(me$`decade:pair`, aes(decade, estimate__)) +
  geom_ribbon(aes(ymin=lower__, ymax=upper__, fill=pair), alpha=0.3) +
  geom_line(aes(color=pair)) +  theme_test() + ylab("Expected correlation") +
  labs(caption="Fig. Fluctuations are variable at the species pair level.") +
  theme(plot.caption = element_text(hjust = 0))

time_summ <- expand_grid(pair=c('AC-AC', 'PJ-AC', 'PJ-PJ', 'PL-AC', 'PL-PJ', 'PL-PL', 'PP-AC', 'PP-PJ', 'PP-PL', 'PP-PP'), decade=unique(summary_t$decade)) %>%
  add_fitted_draws(spline_mod, re_formula = NULL, allow_new_levels=TRUE) %>% 
  median_qi(.width=c(0.5, 0.95)) 

time_summ_sp <- time_summ %>% 
  mutate(spp1=str_sub(pair, 1,2),
    spp2=str_sub(pair, 4,5),
    comp=ifelse(spp1==spp2, "intra", "inter"),
    timechunk=ifelse(decade<1970, "early", "late")) %>% 
  ungroup() %>% 
  dplyr::select(-decade, .row) %>% 
  group_by(pair, spp1, spp2, comp, timechunk, .width, .point, .interval) %>% 
  summarise_all(mean)

s3 <-ggplot(time_summ_sp, aes(x=.value, y=pair, color=timechunk)) +
  geom_pointintervalh(position = position_dodgev(height=0.5)) + theme_test() +
  geom_vline(xintercept = 0, linetype="dashed")  +
  xlab("Expected correlation") + ylab("") +
  scale_color_viridis(discrete = T, option='magma', begin = 0, end=0.4, name = "", labels = c("pre-1970", "post-1970")) +
  # scale_color_grey(start=0.8, end=0.3) + 
  theme(legend.position = 'bottom') +
  theme(plot.margin = unit(c(0,0,0,0), "cm")) +
  guides(color=guide_legend( nrow = 2)) 


plot_grid(s1,
          plot_grid(s2, s3, align='v', axis='lr', rel_heights = c(0.3,1), ncol=1, labels=c('b','c')), labels='a', rel_widths = c(1,0.8))
  
```

```{r spline_mod_site}
spline_mod <- readRDS("saved models/spline_site.rds")
print(spline_mod$formula)
me <- marginal_effects(spline_mod)

ggplot(me$`decade:Site.x`, aes(decade, estimate__)) +
  geom_ribbon(aes(ymin=lower__, ymax=upper__, fill=Site.x), alpha=0.3) +
  geom_line(aes(color=Site.x)) +  theme_test() + ylab("Expected correlation") +
  labs(caption="Fig. Fluctuations are variable at the site level, there is a particularly steep increase for black mountain (San Jacinto).") +
  theme(plot.caption = element_text(hjust = 0))

time_summ <- expand_grid(Site.x=c('bm', 'cm', 'lc', 'pp', 'pr', 'sl', 'sp'), decade=unique(summary_t$decade)) %>%
  add_fitted_draws(spline_mod, re_formula = NULL, allow_new_levels=TRUE) %>% 
  median_qi(.width=c(0.5, 0.95))  %>% 
  left_join(region, by=c("Site.x"="Site"))

time_summ_site <- time_summ %>% 
  mutate(timechunk=ifelse(decade<1970, "early", "late")) %>% 
  ungroup() %>% 
  dplyr::select(-decade, -.row) %>% 
  group_by(Site.x, Region, hilo, timechunk, .width, .point, .interval) %>% 
    summarise_all(mean)
  
s3b <-ggplot(time_summ_site, aes(x=.value, y=interaction(hilo, Region), color=timechunk)) +
  geom_pointintervalh(position = position_dodgev(height=0.5)) + theme_test() +
  geom_vline(xintercept = 0, linetype="dashed")  +
  xlab("Expected correlation") + ylab("") +
  scale_color_viridis(discrete = T, option='magma', begin = 0, end=0.4, name = "", labels = c("pre-1970", "post-1970")) +
  # scale_color_grey(start=0.8, end=0.3) + 
  theme(legend.position = 'bottom') +
  theme(plot.margin = unit(c(0,0,0,0), "cm")) +
  guides(color=guide_legend( nrow = 2)) 

plot_grid(s1b,
          plot_grid(s2, s3b, align='v', axis='lr', rel_heights = c(0.3,1), ncol=1, labels=c('b','c')), labels='a', rel_widths = c(1,0.8))

```

### Climate response model:
Model selection supported SPEI as the best predictor for synchrony.  I included both mean and sd in one model although the variables are correlatedd (~.3).  I did not do multiple regression because of multicollinearity. 

```{r env_model}
clim_mod <- readRDS("saved models/pearson models/clim6.rds")
print(clim_mod$formula)

# hypothesis(clim_mod, "spei12_sd=0", scope="coef", group="Site.x")

data <- clim_mod %>% 
  spread_draws(b_spei12_sd, `r_Site.x`[site,]) %>% 
  mutate(mean=b_spei12_sd + `r_Site.x`)

# test <- group_by(data, site) %>% 
#   summarise(post=length(which(mean>0))/length(mean))

data <- data %>% 
  median_qi(.width=c(0.5,0.75, 0.95)) %>% 
  left_join(region, by=c("site"="Site"))

ggplot(data, aes(x=mean, y=interaction(hilo, Region), color=Region)) +
  geom_pointintervalh(aes(xmin= mean.lower, xmax=mean.upper)) +
  geom_vline(xintercept = 0, linetype='dashed')+
  theme_test() +
  scale_color_viridis(option='plasma', discrete = T) +
  ggtitle("Regional response to SPEI variation") +
  ylab("Site") + xlab("Estimate") +
  theme(axis.title=element_text(size=14))

scaling <- data.frame(spei12_sd=quantile(precip_summary$spei12_sd, probs=c(.025, .25, .5, .75, .975)),
                      spei12_sd_raw=quantile(precip_summary_raw$spei12_sd, probs=c(.025, .25, .5, .75, .975)))
  
clim_summ <- expand_grid(Site.x=unique(summary_t$Site.x), 
                         scaling) %>% 
  add_fitted_draws(clim_mod, re_formula = ~(spei12_sd | Site.x) ) %>% 
  median_qi() %>% 
  left_join(region, by=c("Site.x"="Site")) %>% 
  mutate(signif=ifelse(Region=="Mammoth", "yes", "no"))

env_res <- ggplot(clim_summ, aes(spei12_sd_raw, .value)) +
  geom_ribbon(aes(ymin=.lower, ymax=.upper, fill=Region, group=interaction(Region, hilo)), alpha=0.2) +
  geom_line(aes(color=Region, linetype=signif, group=interaction(Region, hilo))) + theme_test() +
  scale_linetype_manual(values=c("dashed", "solid")) +
  ylab("Predicted synchrony") + 
  xlab("SPEI SD for 30 year intervals") +
  # labs(caption="Fig. Regional relationship between precip variability and expected synchrony. In the lowest latitudes synchrony is highest in \n dry periods while in the most mesic site synchrony is higher in the wet periods.") +
  theme(plot.caption = element_text(hjust = 0)) +
  theme_test() +
  scale_color_viridis(option='plasma', discrete = T) +
  scale_fill_viridis(option='plasma', discrete = T) +
  guides(linetype = FALSE) +
  ggtitle("") +
  labs(fill = "", color="") +
  theme(legend.position = 'bottom') +
  theme(plot.margin = unit(c(0,0.1,0.1,0), "cm"))

env1 <- spei_a +
  scale_color_viridis(option='plasma', discrete = T) +
  scale_linetype_manual(values=c("solid", "solid")) +
  ylab("Annual SPEI") +
  theme(axis.title.x=element_blank()) +
  ggtitle("") +
  theme(plot.margin = unit(c(0,0.3,0.1,0), "cm"))

env2 <- spei_b +
  scale_color_viridis(option='plasma', discrete = T) +
  scale_linetype_manual(values=c("solid", "solid")) +
  ylab("SPEI SD") +
  theme(axis.title.x=element_blank()) +
  ggtitle("") +
  theme(plot.margin = unit(c(0,0.3,0.1,0), "cm"))

env3 <- site_time_grow +
  ylab("Growth correlation") +
  scale_linetype_manual(values=c("solid", "solid")) +
  theme(axis.title.x=element_blank()) +
  ggtitle("") +
  theme(plot.margin = unit(c(0,0.3,0.1,0), "cm"))+
  theme(legend.position = 'none')

plot_grid(
  plot_grid(env3, env2, labels=c("a", "b"), ncol=1),
  env_res, labels=c("", "c"), rel_widths = c(0.8, 1), align='v', axis='tb')


clim_mod <- readRDS("saved models/pearson models/clim6b.rds")
newdata <- summary_t %>%
  group_by(Site.x, pair) %>%
  summarise() %>% 
  mutate(site_pair=str_c(Site.x, pair, sep="_"))

data <- clim_mod %>% 
  spread_draws(b_spei12_sd, `r_Site.x:pair`[site_pair,]) %>% 
  mutate(mean=b_spei12_sd + `r_Site.x:pair`)

# test <- group_by(data, site) %>% 
#   summarise(post=length(which(mean>0))/length(mean))

data2 <- data %>% 
  median_qi(.width=c(0.5,0.75, 0.95)) %>% 
  mutate(Site=str_sub(site_pair, 1,2),
         pair=str_sub(site_pair, start=4)) %>% 
  filter(site_pair%in%newdata$site_pair) %>% 
  left_join(region)

ggplot(data2, aes(x=mean, y=interaction(hilo, Region), color=pair)) +
  geom_pointintervalh(aes(xmin= mean.lower, xmax=mean.upper), position = position_dodgev(height=0.3)) +
  geom_vline(xintercept = 0, linetype='dashed')+
  theme_test() +
  scale_color_viridis(discrete = T) +
  ggtitle("Regional response to SPEI variation") +
  ylab("Site") + xlab("Estimate") +
  theme(axis.title=element_text(size=14))

clim_summ <- expand_grid(newdata,
                         spei12_sd=quantile(summary_t$spei12_sd, probs=c(.025, .25, .5, .75, .975))) %>%
  add_fitted_draws(clim_mod, re_formula = NULL, allow_new_levels=TRUE) %>%
  median_qi() %>%
  left_join(region, by=c("Site.x"="Site"))

ggplot(clim_summ, aes(spei12_sd, .value)) +
  geom_ribbon(aes(ymin=.lower, ymax=.upper, fill=pair), alpha=0.2) +
  geom_line(aes(color=pair)) + theme_test() + facet_grid(hilo~Region)  +
  ylab("Expected correlation") +
  theme(plot.caption = element_text(hjust = 0)) +
  theme_test() +
  scale_color_viridis(discrete = T) +
  scale_fill_viridis(discrete = T)


```

```{r misc, eval=F}

spline_mod <- readRDS("saved models/spline_spp.rds")


time_summ1 <- expand_grid(pair=c('AC-AC', 'PJ-AC', 'PJ-PJ', 'PL-AC', 'PL-PJ', 'PL-PL', 'PP-AC', 'PP-PJ', 'PP-PL', 'PP-PP'), decade=unique(summary_t$decade)) %>%
  add_fitted_draws(spline_mod, re_formula = NULL, allow_new_levels=TRUE) %>% 
  compare_levels(.value, by=pair) %>% 
  median_qi(.width=c(0.5, 0.95)) 

time_summ2 <- time_summ1 %>% 
  mutate(pair1=str_sub(pair, 1,5),
         pair1_spp1=str_sub(pair, 1,2),
         pair1_spp2=str_sub(pair, 4,5),
         pair1_comp=ifelse(pair1_spp1==pair1_spp2, "intra", "inter"),
         pair2=str_sub(pair, 9,13),
         pair2_spp1=str_sub(pair, 9,10),
         pair2_spp2=str_sub(pair, 12,13),
         pair2_comp=ifelse(pair2_spp1==pair2_spp2, "intra", "inter"),
         valid=ifelse(pair1_comp=="intra", str_detect(pair2, pair1_spp1), str_detect(pair1, pair2_spp1))) %>% 
  filter(pair1_comp!=pair2_comp, valid==TRUE) %>% 
  mutate(new_pair=ifelse(pair1_comp=="intra", str_c(pair1, pair2, sep=" - "), str_c(pair2, pair1, sep=" - ")),
         new_inter1=str_sub(new_pair, start=9,10),
         new_inter2=str_sub(new_pair, start=12,13),
         intra_spp=str_sub(new_pair, start=1, 2),
         comp_spp=ifelse(str_detect(new_inter1, intra_spp), new_inter2, new_inter1),
         .value=ifelse(pair1_comp=="intra", .value, .value*-1),
         .upper=ifelse(pair1_comp=="intra", .upper, .upper*-1),
         .lower=ifelse(pair1_comp=="intra", .lower, .lower*-1),
         timechunk=ifelse(decade<1970, "early", "late")) %>% 
  ungroup() %>% 
  dplyr::select(c(new_pair, intra_spp, comp_spp, .value, .upper, .lower, .width, timechunk)) %>% 
  group_by(new_pair, intra_spp, comp_spp, timechunk, .width) %>% 
  summarise_all(mean)

ggplot(time_summ2, aes(x=.value, y=new_pair, color=timechunk)) +
  geom_pointintervalh(position = position_dodgev(height=0.5)) + theme_test() +
  geom_vline(xintercept = 0, linetype="dashed")  +
  xlab("Expected correlation")+ ylab("Species contrast") + 
  labs(caption="Fig. Changes in synchrony differences between intra and interspecific pairing. Post 1970 \n white fir intraspecific synchrony has become stronger than interspecific synchrony.") +
  theme(plot.caption = element_text(hjust = 0))

```

```{r treeclim_fig}

clim.labs <- c("SPEI", "Mean temperature")
names(clim.labs) <- c("spei1", "tmean_C")

ggplot(filter(treeclim, model=="correlation"), aes(reorder(month, monthno), coef,  alpha=significant)) +
  geom_linerange(stat="identity", aes(ymin=0, ymax=coef, color=Species), size=3, position = position_dodge(width=0.5)) +
  geom_point(data=filter(treeclim, model=="response"),
             aes(reorder(month, monthno), coef, fill=Species),
             color="black", shape=21, size=2, position = position_dodge(width=0.5)) +
  theme_test() +
  facet_wrap(~varname, ncol = 1, scales='free', labeller=labeller(varname=clim.labs)) +
  geom_hline(yintercept = 0, size=0.2) +
  scale_fill_viridis(discrete=T, begin=0.2) +
  scale_color_viridis(discrete=T, begin=0.2) + ylab("r") + xlab("Month") +
  guides(alpha = FALSE) +
  theme(
   strip.background = element_blank(), strip.text=element_text(hjust=0)
   )
```



